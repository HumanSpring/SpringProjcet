<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="common/layout/defaultLayout">

<th:block layout:fragment="title">
	<title>this is view page</title>
</th:block>

<th:block layout:fragment="content">
	<div class="card-content container">


		<!-- 제품 이미지, 정보 부분-->
		<section class="py-5 form-horizontal form-view" th:object="${board}">
			<div class="container px-4 px-lg-5 my-5">
				<div class="row gx-4 gx-lg-5 align-items-center">

					<!-- 제품 사진 -->
					<div class="col-md-6">
						<div id="carouselExampleFade" class="carousel slide carousel-fade" data-bs-ride="carousel">
							<div class="carousel-inner">
								<div class="carousel-item active">
									<img src="/imgs/product1.jpg" class="d-block w-100" alt="...">
								</div>
								<div class="carousel-item">
									<img src="/imgs/product2.jpg" class="d-block w-100" alt="...">
								</div>
								<div class="carousel-item">
									<img src="/imgs/product3.jpg" class="d-block w-100" alt="...">
								</div>
							</div>
							<button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleFade" data-bs-slide="prev">
								<span class="carousel-control-prev-icon" aria-hidden="true"></span> <span class="visually-hidden">Previous</span>
							</button>
							<button class="carousel-control-next" type="button" data-bs-target="#carouselExampleFade" data-bs-slide="next">
								<span class="carousel-control-next-icon" aria-hidden="true"></span> <span class="visually-hidden">Next</span>
							</button>
						</div>
					</div>

					<!-- 사진 오른쪽 정보 -->
					<div class="col-md-6">
						<!-- 판매여부 -->
						<div class="small mb-1">
							<!-- <label for="inp-type-1" class="col-sm-2 control-label">판매 상태</label> <span th:text="*{salesStatus}"></span> -->
							<label for="inp-type-1" class="col-sm-2 control-label">판매 상태</label> <span th:text="판매중"></span>
						</div>

						<!-- 상품명 -->
						<h1 class="display-5 fw-bolder">

							<p th:text="*{title}"></p>
						</h1>

						<!-- 상품 가격, 판매 유저 -->
						<div class="fs-5 mb-5">
							<div>
								<span>상품 가격 </span> <span th:text="*{price}+'원'"></span>
							</div>
							<div>
								<span>판매 유저 </span> <span th:text="*{userNo}"></span>
							</div>
							<div>
								<span>등록 날짜 </span> <span th:text="*{#dates.format( writeDate, 'yyyy-MM-dd' )}"></span>
							</div>
							<div>
								<span>조회수 </span> <span th:text="*{viewCount}"></span>
							</div>
						</div>

						<p class="lead">Lorem ipsum dolor sit amet consectetur adipisicing elit. Praesentium at dolorem quidem modi. Nam sequi consequatur obcaecati excepturi alias magni, accusamus eius blanditiis delectus ipsam minima ea iste laborum vero?</p>

						<div class="d-grid gap-2 d-md-block ">
							<!-- 찜 -->
							<button class="btn btn-danger col-sm-3" type="button">찜</button>
							<!-- 신고 -->
							<button class="btn btn-secondary col-sm-3" type="button">
								<a href="#" th:href="@{/reported/boardReportedWrite.do}" onclick="window.open(this.href, '_blank', 'width=500px,height=400px,toolbars=no,scrollbars=no'); return false;" class="boardViewUrl"> 신고 </a>
							</button>
						</div>



					</div>
				</div>
			</div>

			<!-- 내용 -->
			<div class="form-group container px-4 px-lg-5 my-5">
				<label for="inp-type-5" class="col-sm-2 control-label"><br> <b></b>
					<h2>상품 상세 정보</h2></label>
				<div class="col-sm-12 ">
					<p class="form-control boardViewContent" th:text="*{content}"></p>
				</div>
			</div>



		</section>



		<div class="btn_wrap text-center">
			<a th:href="@{list.do}" class="btn btn-default waves-effect waves-light">뒤로가기</a> <a th:href="@{write.do( boardNo=${board.boardNo} )}" class="btn btn-primary waves-effect waves-light">수정하기</a>
			<button type="button" class="btn btn-danger waves-effect waves-light" th:onclick="deleteBoard([[ ${board.boardNo} ]])">삭제하기</button>
		</div>
	</div>
	<!-- /.card-content -->

	<!-- 댓글 영역 -->
	<div class="box-content container">
		<div class="card-content">
			<div class="clearfix">
				<h4 class="box-title pull-left">Comment</h4>
				<!-- /.box-title -->
			</div>

			<form class="form-horizontal form-view">
				<div class="input-group margin-bottom-20">
					<input type="text" id="content" class="form-control" placeholder="">
					<div class="input-group-btn">
						<button th:if="${session.loginMember != null}" type="button" class="btn waves-effect waves-light" th:onclick="insertComment([[${board.boardNo}]], [[${session.loginMember.id}]])">등록</button>
						<button th:unless="${session.loginMember != null}" type="button" class="btn waves-effect waves-light" th:onclick="insertComment([[${board.boardNo}]], 0)">등록</button>
					</div>
					<!-- /.input-group-btn -->
				</div>
				<ul class="notice-list">
				</ul>
			</form>
		</div>
		<!-- /.card-content -->
	</div>
	<!-- /.box-content -->
</th:block>


<!-- 삭제 영역 -->
<th:block layout:fragment="add-script">
	<script th:inline="javascript">
		/*<![CDATA[*/

		function deleteBoard(boardNo) {
			if (confirm(boardNo + "번 게시글을 삭제할까요?")) {
				var uri = /*[[ @{delete.do} ]]*/null;
				var html = "";

				html += '<form name="dataForm" action="'+uri+'" method="post">';
				html += '<input type="hidden" name="boardNo" value="'+boardNo+'" />';
				html += '</form>';

				$("body").append(html);
				document.dataForm.submit();
			}
		}

		/*[- end of function -]*/

		/*]]>*/
		
	/* 댓글 출력 함수 */
	$(function() {
		printCommentList();
	});

	/*<![CDATA[*/
	function printCommentList() {

		var uri = /*[[ @{/comments/} + ${board.boardNo} ]]*/null;

		$.get(uri, function(response) {
			if (isEmpty(response) == false) {
				var commentsHtml = "";

				$(response.commentList).each(function(commentNo, comment) {
					if(comment.secretYn == "N"){
						if(comment.deleteYn == "N") {
							commentsHtml += `
								<li>
									<span class="name">${comment.memberDTO.nickname}</span>
									<span class="desc">${comment.content}</span>
									<span class="time">${moment(comment.writeDate).format('YYYY-MM-DD HH:mm:ss')}</span>
									<!--<button type="button" class="btn btn-xs btn-circle"><i class="fa fa-close" aria-hidden="true"></i></button> -->
								</li>
							`;	
						} else {
							commentsHtml += `
								<li>
									<span class="desc">삭제된 댓글입니다.</span>
									<!--<button type="button" class="btn btn-xs btn-circle"><i class="fa fa-close" aria-hidden="true"></i></button> -->
								</li>
							`;	
						}
					} else {
						commentsHtml += `
							<li>
								<span class="desc">비밀댓글입니다.</span>
								<span class="time">${moment(comment.writeDate).format('YYYY-MM-DD HH:mm:ss')}</span>
								<!--<button type="button" class="btn btn-xs btn-circle"><i class="fa fa-close" aria-hidden="true"></i></button> -->
							</li>
						`;		
					}
					
				});

				$(".notice-list").html(commentsHtml);
			}
		}, "json");
	}
	/*[- end of function -]*/
	/*]]>*/	
	
	/* 댓글 입력 */
	function insertComment(boardNo, memberId) {
		var content = document.getElementById("content");
		if (isEmpty(content.value) == true) {
			content.setAttribute("placeholder", "댓글을 입력해주세요.");
			content.focus();
			return false;
		}
		
		if(memberId == 0){
			alert("로그인을 해주세요.");
			content.value = "";
			return false;
		} else {
			var uri = /*[[@{/comments}]]*/null;
			var headers = {"Content-Type": "application/json", "X-HTTP-Method-Override": "POST"};
			var params = {"boardNo" : boardNo, "content" : content.value, "userNo" :memberId};	/* userNo 일단 1 세션값으로 처리 */	
		}
		
		$.ajax({
			url: uri,
			type: "POST", 
			headers : headers, 
			dataType : "json", 
			data: JSON.stringify(params), 
			success: function(response) {
				if(response.result == false){
					alert("댓글 등록에 실패하였습니다.");
					return false;
				}
				
				printCommentList();
				content.value = "";
			}, 
			error : function(xhr, status, error) {
				alert("에러가 발생하였습니다.");
				return false;
			}
		});
	}
	</script>

</th:block>
</html>